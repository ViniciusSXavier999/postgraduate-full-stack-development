# 4 ‚Üí SUBCONSULTA DE V√ÅRIAS LINHAS E V√ÅRIOS CAMPOS

üèÜ

> N√≥s vimos que quando a sub consulta retorna uma linha, a gente pode utilizar os operadores de compara√ß√£o, a quest√£o √© que esses operadores de compara√ß√£o est√£o preparados para trabalhar com apenas 1 valor, eles n√£o conseguem trabalhar com mais de um valor ao mesmo tempo
> 

üèÜ Quando a sub consulta retorna mais de um valor, a gente √© obrigado a utilizar operadores especiais 


### Retorne mais de uma linha, Use operadores de compara√ß√£o de v√°rias linhas

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos1.png" />

- IN ‚Üí Quando o retorno √© de v√°rios campos
- ANY ‚Üí Quando retorna v√°rios valores
- ALL ‚Üí Tamb√©m √© quando retorna v√°rios valores

üèÜ A diferen√ßa √©:

- ANY ‚Üí leitura √© de ‚ÄòOR‚Äô
- ALL ‚Üí A leitura √© de ‚ÄòAND‚Äô

---

## USANDO O OPERADOR ANY EM SUBCONSULTAS DE V√ÅRIAS LINHAS

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos2.png" />

> Come√ßando pela sub consulta ‚Üí Est√° selecionando o sal√°rio da tabela EMP onde o cargo seja ‚ÄòCLERK‚Äô, essa sub consulta vai retornar todos os sal√°rios dos funcion√°rios que tenham o cargo CLERK.
> 

> Consulta principal ‚Üí Seleciona o c√≥digo do funcion√°rio, o nome e o cargo, da tabela emp, onde o sal√°rio seja menor que qualquer(ANY) (800 OU 1100 OU 950 08 1300) sal√°rio retornado pela sub consulta  E que o cargo seja diferente de ‚ÄúCLERK‚Äù
> 

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos3.png" />

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos4.png" />

---

## USANDO O OPERADOR ALL EM SUBCONSULTAS DE V√ÅRIAS LINHAS

> Lembrando que quando utilizamos o ALL a leitura √© de AND
> 

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos5.png" />

üèÜ ALL ‚Üí QUE SEJA MAIOR QUE TODOS OS VALORES RETORNADOS PELA SUB CONSULTA


> Subconsulta ‚Üí Est√° selecionando a m√©dia dos sal√°rios, da tabela emp, AGRUPADO pelo departamento(deptno)(vai retornar as m√©dias salariais dos departamentos e n√≥s sabemos que temos 3.)
> 

> Consulta principal ‚Üí Selecionando o c√≥digo, nome, e cargo do funcion√°rio, da tabela emp, onde os sal√°rios seja maior que todas as m√©dias salariais dos departamentos
> 

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos6.png" />

> Podemos notar que a sub consulta est√° retornando 3 valores
> 

> Estamos selecionando o c√≥digo, nome e cargo dos funcion√°rios onde o sal√°rio seja maior que os dados retornados pela sub consulta
> 

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos7.png" />

---

## PRATICANDO!!

### TENTANDO UTILIZAR OPERADOR DE COMPARA√á√ÉO DE UMA UNICA LINHA COM QUERY QUE RETORNA MULTIPLOS VALORES

> MOSTRAR√Å UM ERRO!, POIS a consulta retorna mais de 1 valor.
> 

```sql
SELECT empno, ename, sal, job
FROM scott.emp 
WHERE sal >  (SELECT  sal
             FROM scott.emp
             where job='CLERK')
```

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos8.png" />

### CONCERTANDO A QUERY COM O OPERADOR CORRETO PARA OPERA√á√ïES DE MULTIPLOS VALORES (UTILIZANDO O OPERADOR ANY(QUALQUER VALOR))

```sql
SELECT empno, ename, sal, job
FROM scott.emp 
WHERE sal > ANY (SELECT  sal
             FROM scott.emp
             where job='CLERK')
```

> sal > ANY ‚Üí Qualquer valor retornado pela sub consulta
> 

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos9.png" />

üèÜ Esta retornando o c√≥digo, nome, sal√°rio e cargo de todos os funcion√°rios que tem sal√°rio maior QUALQUER SAL√ÅRIO DO CARGO CLERK


### DESCOBRINDO OS SAL√ÅRIOS DO CARGO CLERK

```sql
SELECT SAL 
FROM SCOTT.EMP
WHERE job = 'CLERK'
```

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos10.png" />

### UTILIZANDO O OPERADOR FULL

> Vamos fazer os sal√°rios dos funcion√°rios maior que todas as m√©dias salariais agrupadas pelo departamento
> 

```sql
SELECT empno, ename, sal, job
FROM scott.emp 
WHERE sal > ALL (SELECT  avg(sal)
             FROM scott.emp
             GROUP BY deptno)
```

üèÜ

- SELECIONANDO o c√≥digo do funcion√°rio, nome, sal√°rio e cargo
- DA TABELA emp
- ONDE O SAL√ÅRIO √â MAIOR QUE TODAS AS M√âDIAS SALARIAIS POR DEPARTAMENTO


<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos11.png" />

### DESCOBRINDO AS M√âDIAS SAL√ÅRIAIS

```sql
SELECT avg(sal)
FROM scott.emp
GROUP BY deptno;
```

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos12.png" />

üèÜ J√° que queremos saber todos os funcion√°rios que ganham mais que a m√©dia salarial de todos os departamentos, ou seja, o salario tem que ser maior que os resultados da imagem.


### UTILIZANDO A CL√ÅUSULA IN

> SUB CONSULTA ‚Üí Estamos selecionando o cargo e o salario da tabela emp onde o salario √© maior que 2500
> 

```sql
  SELECT  job, sal
     FROM scott.emp
     WHERE  sal > 2500
```

üèÜ Primeiro estamos vendo o resultado da sub consulta

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos13.png" />


### CONSULTA PRINCIPAL

```sql
SELECT empno, ename, sal, job
FROM scott.emp 
WHERE (job, sal) IN (SELECT  job, sal
             FROM scott.emp
             WHERE  sal > 2500)
```

üèÜ

- SELECIONANDO O C√ìDIGO DO FUNCIONARIO, O NOME, SALARIO E CARGO
- DA TABELA EMP
- ONDE TENHAM O MESMO CARGO E SALARIO DOS SALARIOS QUE SEJAM MAIOR QUE 2500

<img width="600" src = "https://github.com/ViniciusSXavier999/Assets/blob/main/P%C3%B3sGradua%C3%A7%C3%A3o/subConsultaV%C3%A1riasLinhasEV%C3%A1riosCampos14.png" />

### MELHOR EXPLICA√á√ÉO DO IN

üèÜ

A cl√°usula **`IN`** em SQL √© um operador de compara√ß√£o usado para verificar se um valor est√° **dentro de um conjunto de valores** especificados. Ela √© uma maneira pr√°tica de fazer m√∫ltiplas compara√ß√µes sem precisar usar v√°rios **operadores `OR`**. Ao utilizar `IN`, voc√™ pode verificar se um valor corresponde a qualquer valor dentro de uma lista de valores, o que facilita a escrita e leitura da consulta.

### Sintaxe da cl√°usula `IN`

A sintaxe b√°sica do operador `IN` √© a seguinte:

```sql
SELECT coluna1, coluna2, ...
FROM tabela
WHERE coluna IN (valor1, valor2, valor3, ...);

```

Aqui, a cl√°usula `IN` compara a **`coluna`** com os valores especificados no conjunto `(valor1, valor2, valor3, ...)`. Se o valor na coluna corresponder a **qualquer** valor da lista, a condi√ß√£o √© verdadeira e a linha √© retornada.

### Exemplo b√°sico de uso do `IN`

```sql
SELECT nome, salario
FROM empregados
WHERE departamento_id IN (1, 2, 3);

```

### Explica√ß√£o:

- A consulta retorna o **nome** e **sal√°rio** de todos os empregados cujos **`departamento_id`** √© **1**, **2** ou **3**.
- Em vez de escrever algo como:

Usamos o operador `IN` para simplificar a consulta.
    
    ```sql
    WHERE departamento_id = 1 OR departamento_id = 2 OR departamento_id = 3
    
    ```
    

### `IN` com subconsulta

A cl√°usula `IN` tamb√©m pode ser usada com **subconsultas** para comparar um valor com os resultados de uma outra consulta. Neste caso, a subconsulta retorna um conjunto de valores, e o operador `IN` verifica se o valor de uma coluna da consulta externa est√° presente nesse conjunto.

### Exemplo com subconsulta:

```sql
SELECT nome, salario
FROM empregados
WHERE departamento_id IN (SELECT departamento_id FROM departamentos WHERE localizacao = 'S√£o Paulo');

```

### Explica√ß√£o:

- A subconsulta `(SELECT departamento_id FROM departamentos WHERE localizacao = 'S√£o Paulo')` retorna os `departamento_id` dos departamentos que est√£o localizados em 'S√£o Paulo'.
- A consulta externa ent√£o retorna os **nomes** e **sal√°rios** dos **empregados** cujos **`departamento_id`** est√£o na lista de departamentos de 'S√£o Paulo' retornada pela subconsulta.

### `NOT IN`

O operador `NOT IN` √© o oposto de `IN`. Ele verifica se um valor **n√£o est√° presente** em um conjunto de valores ou resultados de subconsulta.

### Exemplo com `NOT IN`:

```sql
SELECT nome, salario
FROM empregados
WHERE departamento_id NOT IN (1, 2, 3);

```

### Explica√ß√£o:

- A consulta retorna o **nome** e **sal√°rio** de todos os empregados **cujo `departamento_id` n√£o √©** 1, 2 ou 3.
- Em vez de escrever:

Usamos o operador `NOT IN` para tornar a consulta mais leg√≠vel.
    
    ```sql
    WHERE departamento_id <> 1 AND departamento_id <> 2 AND departamento_id <> 3
    
    ```
    

### Compara√ß√£o com `=` e `OR`

### Compara√ß√£o com `IN`:

Quando voc√™ tem um n√∫mero de valores para comparar, o operador `IN` √© mais conciso e leg√≠vel:

```sql
SELECT nome
FROM empregados
WHERE departamento_id IN (1, 2, 3);

```

### Compara√ß√£o com `=` e `OR`:

Voc√™ tamb√©m poderia escrever a mesma consulta usando `=` e `OR`, mas a consulta ficaria mais longa e menos leg√≠vel:

```sql
SELECT nome
FROM empregados
WHERE departamento_id = 1 OR departamento_id = 2 OR departamento_id = 3;

```

### Diferen√ßa entre `IN` e `=` com subconsulta

- **`IN`** com subconsulta √© usado quando a subconsulta retorna **m√∫ltiplos valores**. Ele verifica se o valor na consulta externa est√° presente em **qualquer um dos resultados** da subconsulta.
- **`=`** com subconsulta √© usado quando a subconsulta retorna **apenas um √∫nico valor**. Ele verifica se o valor na consulta externa √© **igual ao valor √∫nico** retornado pela subconsulta.

### Exemplo com `IN` e subconsulta:

```sql
SELECT nome
FROM empregados
WHERE departamento_id IN (SELECT departamento_id FROM departamentos WHERE localizacao = 'S√£o Paulo');

```

### Exemplo com `=` e subconsulta (supondo que a subconsulta retorne um √∫nico valor):

```sql
SELECT nome
FROM empregados
WHERE departamento_id = (SELECT departamento_id FROM departamentos WHERE localizacao = 'S√£o Paulo' AND nome = 'TI');

```

### Considera√ß√µes Importantes:

1. **Desempenho**: O uso de `IN` com listas de valores pode ser mais eficiente que m√∫ltiplos `OR`, especialmente quando o n√∫mero de itens na lista √© grande. No entanto, se a subconsulta retornar muitos resultados, pode afetar o desempenho dependendo do banco de dados e da complexidade da consulta.
2. **`NULL` no conjunto**: Se voc√™ usar `IN` com uma lista de valores que contenha `NULL`, os resultados podem ser inesperados. Em SQL, qualquer compara√ß√£o com `NULL` retorna **falso**, ent√£o, se a subconsulta retornar um `NULL`, a compara√ß√£o falhar√°, e voc√™ pode n√£o obter os resultados esperados.

### Exemplo de problema com `NULL`:

```sql
SELECT nome
FROM empregados
WHERE departamento_id IN (1, 2, NULL);

```

Este exemplo pode **n√£o retornar resultados** porque qualquer compara√ß√£o com `NULL` √© considerada **desconhecida** (n√£o verdadeira), o que pode causar resultados inesperados.

### Conclus√£o:

A cl√°usula **`IN`** √© uma ferramenta poderosa para verificar se um valor est√° dentro de um conjunto de valores, simplificando consultas e tornando-as mais leg√≠veis. Voc√™ pode us√°-la tanto com listas de valores como com subconsultas, e tamb√©m pode usar **`NOT IN`** para encontrar valores que n√£o est√£o no conjunto especificado.

